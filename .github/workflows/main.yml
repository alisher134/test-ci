name: CI

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'src/**'

jobs:
  build-and-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint code
        run: yarn lint

      - name: Type check
        run: yarn tsc --noEmit
        
      - name: Build project
        run: yarn build

  code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AI Code Review
        uses: anc95/ChatGPT-CodeReview@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_ENDPOINT: https://api.openai.com/v1
          MODEL: gpt-4o-mini
          LANGUAGE: Russian
          PROMPT: |
            –¢—ã Senior Frontend Developer (JS/TS, React, Next.js, Node.js). 
            
            –ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
            - üî¥ –ö–†–ò–¢–ò–ß–ù–û: –æ—à–∏–±–∫–∏, –±–∞–≥–∏, —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, breaking changes
            - üü° –í–ê–ñ–ù–û: –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, best practices
            - üü¢ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò: —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å, —Å—Ç–∏–ª—å –∫–æ–¥–∞
            
            –î–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã:
            1. –£–∫–∞–∂–∏ —Ñ–∞–π–ª –∏ —Å—Ç—Ä–æ–∫—É
            2. –û–±—ä—è—Å–Ω–∏ –ø—Ä–æ–±–ª–µ–º—É
            3. –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–æ–º –∫–æ–¥–∞
            4. –û—Ü–µ–Ω–∏ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç
            
            –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏—è—Ö.
          top_p: 1
          temperature: 0.3
          max_tokens: 4000
          MAX_PATCH_LENGTH: 30000
          IGNORE_PATTERNS: |
            /node_modules/**/*
            *.md
            *.json
            /dist/**/*
            /.git/**/*
